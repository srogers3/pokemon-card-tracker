# Daily Submission Limit, Egg Markers & Optional Product â€” Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Prevent duplicate daily submissions per store, show egg markers on already-reported stores, show a fun "already scouted" message, and make product selection optional for "empty shelves" reports.

**Architecture:** Server-side rate limiting via a new `hasSubmittedToStoreToday()` query in trust.ts. The `getStoresWithSightings` action gains auth awareness and returns a `hasSubmittedToday` boolean per store. The flag flows through props to `PokeballMarker` (egg sprite) and `StoreDetailPanel` (message). A Drizzle migration makes `productId` nullable for general "not found" reports.

**Tech Stack:** Next.js 16 (App Router, server actions), React 19, Drizzle ORM + Neon PostgreSQL, Clerk auth, TypeScript

---

### Task 1: DB Migration â€” Make `productId` Nullable

**Files:**
- Modify: `src/db/schema.ts:93` â€” remove `.notNull()` from `productId`
- Create: `drizzle/0004_*.sql` â€” generated by `drizzle-kit generate`

**Step 1: Update schema**

In `src/db/schema.ts`, change line 93 from:

```ts
  productId: uuid("product_id")
    .notNull()
    .references(() => products.id),
```

to:

```ts
  productId: uuid("product_id")
    .references(() => products.id),
```

**Step 2: Generate the migration**

Run: `npx drizzle-kit generate`
Expected: Creates `drizzle/0004_*.sql` with `ALTER TABLE "restock_sightings" ALTER COLUMN "product_id" DROP NOT NULL;`

**Step 3: Apply the migration**

Run: `npx drizzle-kit push`
Expected: Migration applied successfully.

**Step 4: Commit**

```bash
git add src/db/schema.ts drizzle/
git commit -m "feat: make productId nullable for general empty-shelves reports"
```

---

### Task 2: Add `hasSubmittedToStoreToday` to Trust Module

**Files:**
- Modify: `src/lib/trust.ts` â€” add new exported function

**Step 1: Add the function**

Add at the end of `src/lib/trust.ts`:

```ts
export async function hasSubmittedToStoreToday(
  userId: string,
  storeId: string
): Promise<boolean> {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const [result] = await db
    .select({ count: sql<number>`count(*)::int` })
    .from(restockSightings)
    .where(
      and(
        eq(restockSightings.reportedBy, userId),
        eq(restockSightings.storeId, storeId),
        gte(restockSightings.createdAt, today)
      )
    );

  return (result?.count ?? 0) > 0;
}
```

**Step 2: Also add a bulk version for the data loader**

Add right after:

```ts
export async function getSubmittedStoreIdsToday(
  userId: string
): Promise<Set<string>> {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const rows = await db
    .select({ storeId: restockSightings.storeId })
    .from(restockSightings)
    .where(
      and(
        eq(restockSightings.reportedBy, userId),
        gte(restockSightings.createdAt, today)
      )
    );

  return new Set(rows.map((r) => r.storeId));
}
```

**Step 3: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 4: Commit**

```bash
git add src/lib/trust.ts
git commit -m "feat: add per-store daily submission check and bulk lookup"
```

---

### Task 3: Enforce Per-Store Rate Limit in `submitTip`

**Files:**
- Modify: `src/app/dashboard/submit/actions.ts` â€” add store-level check, handle null productId

**Step 1: Add per-store check**

Add this import at the top (alongside existing trust imports):

```ts
import { hasSubmittedToStoreToday } from "@/lib/trust";
```

Wait â€” `hasSubmittedToStoreToday` is already in the trust module which is imported. Just add it to the destructured import.

Change the existing import line from:

```ts
import {
  shouldAutoVerify,
  canSubmitReport,
  checkCorroboration,
  adjustTrustScore,
  updateReporterStats,
} from "@/lib/trust";
```

to:

```ts
import {
  shouldAutoVerify,
  canSubmitReport,
  hasSubmittedToStoreToday,
  checkCorroboration,
  adjustTrustScore,
  updateReporterStats,
} from "@/lib/trust";
```

**Step 2: Add the per-store check after the global rate limit check**

After line `if (!canSubmit) throw new Error("Daily report limit reached (max 10)");`, add:

```ts
  const storeId = formData.get("storeId") as string;
  const alreadyReported = await hasSubmittedToStoreToday(userId, storeId);
  if (alreadyReported) throw new Error("Already reported this location today");
```

Remove the duplicate `const storeId` declaration that was previously on the line after.

**Step 3: Handle nullable productId**

Change:

```ts
  const productId = formData.get("productId") as string;
```

to:

```ts
  const productId = (formData.get("productId") as string) || null;
```

And wrap the corroboration check to skip when productId is null:

```ts
  // Check for corroboration if not already auto-verified (only for product-specific reports)
  if (!autoVerify && productId) {
    const corroboratedUserId = await checkCorroboration(sighting.id, storeId, productId, sightedAt);
    if (corroboratedUserId) {
      await adjustTrustScore(userId, 10);
    }
  } else if (autoVerify) {
    await hatchEgg(sighting.id, false);
    await adjustTrustScore(userId, 5);
  }
```

**Step 4: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 5: Commit**

```bash
git add src/app/dashboard/submit/actions.ts
git commit -m "feat: enforce per-store daily submission limit, handle null productId"
```

---

### Task 4: Add `hasSubmittedToday` Flag to `getStoresWithSightings`

**Files:**
- Modify: `src/app/dashboard/actions.ts` â€” add auth, query submitted stores, add flag

**Step 1: Add imports and auth**

Add to imports:

```ts
import { auth } from "@clerk/nextjs/server";
import { getSubmittedStoreIdsToday } from "@/lib/trust";
```

Change `innerJoin` import â€” need `leftJoin`:

Add `leftJoin` to the drizzle-orm import if not already there (replace `eq` line or add alongside).

**Step 2: Get userId and submitted store IDs**

At the top of `getStoresWithSightings()`, add:

```ts
  const { userId } = await auth();
  const submittedStoreIds = userId
    ? await getSubmittedStoreIdsToday(userId)
    : new Set<string>();
```

**Step 3: Change innerJoin to leftJoin on products**

Change:

```ts
    .innerJoin(products, eq(restockSightings.productId, products.id))
```

to:

```ts
    .leftJoin(products, eq(restockSightings.productId, products.id))
```

Update the select to handle null productName â€” change:

```ts
      productName: products.name,
```

to:

```ts
      productName: products.name,
```

(The type will now be `string | null`.)

**Step 4: Add `hasSubmittedToday` to return**

Change the return mapping from:

```ts
  return allStores.map((store) => {
    const storeSightings = sightingsByStore.get(store.id) ?? [];
    return {
      store,
      lastSightingAt: storeSightings.length > 0 ? storeSightings[0].sightedAt : null,
      sightings: storeSightings.map((s) => ({
        id: s.id,
        productName: s.productName,
        status: s.status,
        sightedAt: s.sightedAt,
        verified: s.verified,
      })),
    };
  });
```

to:

```ts
  return allStores.map((store) => {
    const storeSightings = sightingsByStore.get(store.id) ?? [];
    return {
      store,
      lastSightingAt: storeSightings.length > 0 ? storeSightings[0].sightedAt : null,
      hasSubmittedToday: submittedStoreIds.has(store.id),
      sightings: storeSightings.map((s) => ({
        id: s.id,
        productName: s.productName ?? "General report",
        status: s.status,
        sightedAt: s.sightedAt,
        verified: s.verified,
      })),
    };
  });
```

**Step 5: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 6: Commit**

```bash
git add src/app/dashboard/actions.ts
git commit -m "feat: add hasSubmittedToday flag to store data, leftJoin for nullable product"
```

---

### Task 5: Pass `hasSubmittedToday` Through `StoreMap`

**Files:**
- Modify: `src/components/map/store-map.tsx` â€” update interface, pass prop down

**Step 1: Update `StoreWithSightings` interface**

Add `hasSubmittedToday` to the interface:

```ts
interface StoreWithSightings {
  store: Store;
  lastSightingAt: Date | null;
  hasSubmittedToday: boolean;
  sightings: {
    id: string;
    productName: string;
    status: string;
    sightedAt: Date;
    verified: boolean;
  }[];
}
```

**Step 2: Pass to PokeballMarker**

In the `storeData.map()` rendering, add the prop:

```tsx
<PokeballMarker
  key={sd.store.id}
  store={sd.store}
  isSelected={selectedStore?.store.id === sd.store.id}
  hasSubmittedToday={sd.hasSubmittedToday}
  setMarkerRef={setMarkerRef}
  onClick={() => {
    setSelectedStore(sd);
    if (map && sd.store.latitude && sd.store.longitude) {
      map.panTo({ lat: sd.store.latitude, lng: sd.store.longitude });
    }
  }}
/>
```

**Step 3: Pass to StoreDetailPanel**

In the `selectedStore &&` section, add the prop:

```tsx
<StoreDetailPanel
  store={selectedStore.store}
  sightings={selectedStore.sightings}
  products={products}
  hasSubmittedToday={selectedStore.hasSubmittedToday}
  onClose={() => setSelectedStore(null)}
/>
```

**Step 4: Handle new stores from `searchNearbyStores`**

In `handleSearchArea`, new stores added dynamically need `hasSubmittedToday: false` (user hasn't reported to a store they just discovered):

```ts
existing.set(store.id, { store, lastSightingAt: null, hasSubmittedToday: false, sightings: [] });
```

**Step 5: Type check**

Run: `npx tsc --noEmit`
Expected: May show errors in PokeballMarker and StoreDetailPanel since they don't accept the new prop yet. That's fine â€” next tasks fix it.

**Step 6: Commit**

```bash
git add src/components/map/store-map.tsx
git commit -m "feat: thread hasSubmittedToday through StoreMap to children"
```

---

### Task 6: Egg Sprite in `PokeballMarker`

**Files:**
- Modify: `src/components/map/pokeball-marker.tsx` â€” accept `hasSubmittedToday`, show egg

**Step 1: Add egg sprite constant**

Add at the top of the file (after imports):

```ts
const EGG_SPRITE_URL = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/lucky-egg.png";
```

**Step 2: Add prop to component signature**

Change:

```ts
export function PokeballMarker({
  store,
  onClick,
  isSelected,
  setMarkerRef,
}: {
  store: Store;
  onClick: () => void;
  isSelected: boolean;
  setMarkerRef?: (marker: google.maps.marker.AdvancedMarkerElement | null, id: string) => void;
}) {
```

to:

```ts
export function PokeballMarker({
  store,
  onClick,
  isSelected,
  hasSubmittedToday,
  setMarkerRef,
}: {
  store: Store;
  onClick: () => void;
  isSelected: boolean;
  hasSubmittedToday: boolean;
  setMarkerRef?: (marker: google.maps.marker.AdvancedMarkerElement | null, id: string) => void;
}) {
```

**Step 3: Conditional sprite/border**

After `const wild = getWildPokemon(store.id);`, add:

```ts
  const spriteUrl = hasSubmittedToday ? EGG_SPRITE_URL : wild.spriteUrl;
  const spriteName = hasSubmittedToday ? "Egg" : wild.name;
  const borderColor = hasSubmittedToday ? "#9CA3AF" : (RARITY_BORDER_COLORS[wild.rarity] ?? "#9CA3AF");
  const isRainbow = !hasSubmittedToday && borderColor === "rainbow";
```

Remove the old `borderColor` and `isRainbow` lines.

**Step 4: Update the JSX to use new variables**

Change the `title` prop:

```tsx
title={`${store.name} â€” ${hasSubmittedToday ? "Already scouted!" : `Wild ${spriteName}!`}`}
```

Change the `<img>` tag:

```tsx
<img
  src={spriteUrl}
  alt={spriteName}
  width={spriteSize}
  height={spriteSize}
  style={{
    imageRendering: "pixelated",
    transition: "width 200ms ease, height 200ms ease",
  }}
/>
```

**Step 5: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 6: Commit**

```bash
git add src/components/map/pokeball-marker.tsx
git commit -m "feat: show egg sprite on already-submitted stores"
```

---

### Task 7: "Already Scouted" Message in `StoreDetailPanel`

**Files:**
- Modify: `src/components/map/store-detail-panel.tsx` â€” accept prop, show message

**Step 1: Add prop**

Change the component signature to accept `hasSubmittedToday`:

```ts
export function StoreDetailPanel({
  store,
  sightings,
  products,
  hasSubmittedToday,
  onClose,
}: {
  store: Store;
  sightings: Sighting[];
  products: Product[];
  hasSubmittedToday: boolean;
  onClose: () => void;
}) {
```

**Step 2: Replace the report section**

Change the `{/* Report Sighting button or inline form */}` section from:

```tsx
{showForm ? (
  <MapSightingForm
    storeId={store.id}
    products={products}
    onCancel={() => setShowForm(false)}
  />
) : (
  <Button
    variant="accent"
    className="w-full"
    onClick={() => setShowForm(true)}
  >
    Report Sighting
  </Button>
)}
```

to:

```tsx
{hasSubmittedToday ? (
  <div className="bg-muted/50 rounded-lg p-4 text-center space-y-1">
    <p className="text-2xl">ðŸ¥š</p>
    <p className="font-semibold text-sm">Your Trainer already scouted this location today!</p>
    <p className="text-xs text-muted-foreground">Come back tomorrow â€” a new Pokemon might be waiting.</p>
  </div>
) : showForm ? (
  <MapSightingForm
    storeId={store.id}
    products={products}
    onCancel={() => setShowForm(false)}
  />
) : (
  <Button
    variant="accent"
    className="w-full"
    onClick={() => setShowForm(true)}
  >
    Report Sighting
  </Button>
)}
```

**Step 3: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 4: Commit**

```bash
git add src/components/map/store-detail-panel.tsx
git commit -m "feat: show already-scouted message when store submitted today"
```

---

### Task 8: Conditional Product Field in `MapSightingForm`

**Files:**
- Modify: `src/components/map/map-sighting-form.tsx` â€” status-driven product visibility

**Step 1: Add status state**

Add `useState` to the existing React import. Then add state inside the component:

```ts
const [status, setStatus] = useState<string>("");
```

**Step 2: Change the Status select to be controlled**

Replace the status `<Select>` with a controlled version:

```tsx
<div>
  <Label htmlFor="map-status" className="text-xs">Stock Status</Label>
  <Select name="status" required value={status} onValueChange={setStatus}>
    <SelectTrigger className="h-9">
      <SelectValue placeholder="Select status" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="found">Yes â€” Found cards!</SelectItem>
      <SelectItem value="not_found">No â€” Shelves were empty</SelectItem>
    </SelectContent>
  </Select>
</div>
```

**Step 3: Move status field ABOVE product field and make product conditional**

Reorder the form fields so status comes first, then wrap the product field:

```tsx
{status !== "not_found" && (
  <div>
    <Label htmlFor="map-productId" className="text-xs">Product</Label>
    <Select name="productId" required={status === "found"}>
      <SelectTrigger className="h-9">
        <SelectValue placeholder="Select a product" />
      </SelectTrigger>
      <SelectContent>
        {products.map((p) => (
          <SelectItem key={p.id} value={p.id}>
            {p.name}
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  </div>
)}
```

The full field order should be: Status â†’ Product (conditional) â†’ When â†’ Notes.

**Step 4: Add `useState` to the import**

Change:

```ts
import { useRef } from "react";
```

to:

```ts
import { useRef, useState } from "react";
```

**Step 5: Type check**

Run: `npx tsc --noEmit`
Expected: No errors.

**Step 6: Commit**

```bash
git add src/components/map/map-sighting-form.tsx
git commit -m "feat: hide product selection for empty-shelves reports"
```

---

### Task 9: Final Build Verification

**Step 1: Full type check**

Run: `npx tsc --noEmit`
Expected: No type errors.

**Step 2: Build**

Run: `npm run build`
Expected: Build succeeds.

**Step 3: Commit any fixups if needed**

If build revealed issues, fix and commit.
